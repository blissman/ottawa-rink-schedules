let rinks = {
    "Albion-Heatherington Recreation Centre": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/albion-heatherington-recreation-centre",
        "address": "1560 Heatherington Road Ottawa ON K1V 9P5 Canada"
    },
    "Aquaview Community Hall": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/aquaview-community-hall",
        "address": "318 Aquaview Drive Ottawa ON K4A 0B5 Canada"
    },
    "Ben Franklin Place rink": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/ben-franklin-place-rink",
        "address": "101 Centrepointe Drive Ottawa ON K2G 0B5 Canada"
    },
    "Bob MacQuarrie Recreation Complex - Orléans": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/bob-macquarrie-recreation-complex-orleans",
        "address": "1490 Youville Drive Ottawa ON K1C 2X8 Canada"
    },
    "Brewer Pool and Arena": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/brewer-pool-and-arena",
        "address": "100 Brewer Way Ottawa ON K1S 5T1 Canada"
    },
    "Canterbury Recreation Complex": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/canterbury-recreation-complex",
        "address": "2185 Arch Street Ottawa ON K1G 2H5 Canada"
    },
    "CARDELREC Recreation Complex Goulbourn": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/cardelrec-recreation-complex-goulbourn",
        "address": "1500 Shea Road Ottawa ON K2S 0B2 Canada"
    },
    "Carleton Heights community centre": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/carleton-heights-community-centre",
        "address": "1665 Apeldoorn Avenue Ottawa ON K2C 1V6 Canada"
    },
    "Dovercourt Recreation Centre": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/dovercourt-recreation-centre",
        "address": "411 Dovercourt Avenue Ottawa ON K2A 0S9 Canada"
    },
    "Fred Barrett Arena": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/fred-barrett-arena",
        "address": "3280 Leitrim Road Ottawa ON K1T 3Z4 Canada"
    },
    "Greely Community Centre": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/greely-community-centre",
        "address": "1448 Meadow Drive Greely ON K4P 1B1 Canada"
    },
    "Howard Darwin Centennial Arena": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/howard-darwin-centennial-arena",
        "address": "1765 Merivale Road Ottawa ON K2G 1E1 Canada"
    },
    "Jack Charron Arena": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/jack-charron-arena",
        "address": "10 McKitrick Drive Ottawa ON K2L 1T7 Canada"
    },
    "Jim Tubman Chevrolet Rink": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/jim-tubman-chevrolet-rink",
        "address": "2185 Arch Street Ottawa ON K1G 2H5 Canada"
    },
    "Johnny Leroux Stittsville Community Arena": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/johnny-leroux-stittsville-community-arena",
        "address": "10 Warner-Colpitts Lane Ottawa ON K2H 6N4 Canada"
    },
    "Kanata Recreation Complex": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/kanata-recreation-complex",
        "address": "100 Charlie Rogers Place Ottawa ON K2V 1A2 Canada"
    },
    "Lansdowne Park": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/lansdowne-park",
        "address": "1525 Princess Patricia Ottawa ON K1S 5J3 Canada"
    },
    "Lois Kemp Arena (Blackburn)": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/lois-kemp-arena-blackburn",
        "address": "200 Glen Park Drive Ottawa ON K1B 5A3 Canada"
    },
    "Manotick Community Centre and Mike O’Neil Arena": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/manotick-community-centre-and-mike-oneil-arena",
        "address": "5572 Doctor Leach Drive Ottawa ON K4M 1L7 Canada"
    },
    "McNabb Arena and Community Centre": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/mcnabb-arena-and-community-centre",
        "address": "180 Percy Street Ottawa ON K1R 6E5 Canada"
    },
    "Michele Heights Community Centre": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/michele-heights-community-centre",
        "address": "2955 Michele Drive Ottawa ON K2B 8G3 Canada"
    },
    "Minto Recreation Complex - Barrhaven": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/minto-recreation-complex-barrhaven",
        "address": "3500 Cambrian Road Ottawa ON K2J 0V1 Canada"
    },
    "Navan Memorial Centre": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/navan-memorial-centre",
        "address": "1295 Colonial Road Ottawa ON K4B 1N1 Canada"
    },
    "Nepean Sportsplex": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/nepean-sportsplex",
        "address": "1701 Woodroffe Avenue Ottawa ON K2G 1W2 Canada"
    },
    "Osgoode Community Centre - Stuart Homes Arena": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/osgoode-community-centre-stuart-homes-arena",
        "address": "5660 Osgoode Main Street Osgoode ON K0A 2W0 Canada"
    },
    "Osgoode Community Centre and Stuart Holmes Arena": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/osgoode-community-centre-and-stuart-holmes-arena",
        "address": "5660 Osgoode Main Street Ottawa ON K0A 2W0 Canada"
    },
    "Ray Friel Recreation Complex": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/ray-friel-recreation-complex",
        "address": "1585 Tenth Line Road Ottawa ON K1E 3E8 Canada"
    },
    "South Fallingbrook Community Centre": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/south-fallingbrook-community-centre",
        "address": "998 Valin Street Ottawa ON K4A 4B5 Canada"
    },
    "St-Laurent Complex": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/st-laurent-complex",
        "address": "525 Côté Street Ottawa ON K1K 0Z8 Canada"
    },
    "Tom Brown Arena": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/tom-brown-arena",
        "address": "141 Bayview Station Road Ottawa ON K1Y 4M3 Canada"
    },
    "Vernon Recreation Centre": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/vernon-recreation-centre",
        "address": "7950 Lawrence Street Winchester ON K0C 2K0 Canada"
    },
    "Walter Baker Sports Centre": {
        "href": "https://ottawa.ca/en/recreation-and-parks/recreation-facilities/facility-listing/walter-baker-sports-centre",
        "address": "100 Malvern Drive Ottawa ON K2J 2G5 Canada"
    }
};

const parser = new DOMParser();
const tables = [];

const appendSchedules = (elements) => {
    const header = document.getElementsByTagName('h1')[0];
    elements.forEach((element) => {
        header.after(element);
    });
};

const rinkKeys = Object.keys(rinks);

rinkKeys.forEach((rink) => {
    fetch(rinks[rink].href)
        .then((response) => response.text())
        .then((data) => parser.parseFromString(data, "text/html"))
        .then((output) => rinks[rink]['page'] = output);
})

const parsePages = () => {
    for (rink in rinks) {
        const page = rinks[rink]['page'];
        const buttons = Array.from(page.getElementsByTagName("button"));
        buttons.forEach((button) => {
            const expected = /(\bdrop-in\b.*\bskat.*\b)/i;
            const chevrolet = /(\btubman\b.*\bchevrolet.*\b)/i;
            const chevSched = /(\bdrop-in\b.*\bschedule.*\b)/i;
            if (button.textContent.match(expected) && !rink.match(chevrolet)) {
                try {
                    const parent = button.parentElement.parentElement.parentElement;
                    let table = parent.getElementsByTagName('table')[0].cloneNode(true);
                    let caption = table.getElementsByTagName('caption')[0];
                    const captionRegex = /.+?(?=\-)/i;
                    const captionText = caption.innerHTML;
                    const anchorTag = `<a href=${rinks[rink]['href']}> ${rink}</a>: <a href="https://www.google.com/maps/place/${rinks[rink]['address']}"> ${rinks[rink]['address']}</a> `;
                    caption.innerHTML = captionText.replace(captionRegex, anchorTag);
                    tables.push(table);
                } catch (error) {
                    console.warn(`${rink} - ${error}`);
                }
            } else if (rink.match(chevrolet) && button.textContent.match(chevSched)) {
                try {
                    const parent = button.parentElement.parentElement.parentElement;
                    let table = parent.getElementsByTagName('table')[0].cloneNode(true);
                    let caption = table.getElementsByTagName('caption')[0];
                    const captionRegex = /.+?(?=\-)/i;
                    const captionText = caption.innerHTML;
                    const anchorTag = `<a href=${rinks[rink]['href']}> ${rink}</a>: <a href="https://www.google.com/maps/place/${rinks[rink]['address']}"> ${rinks[rink]['address']}</a> `;
                    caption.innerHTML = captionText.replace(captionRegex, anchorTag);
                    tables.push(table);
                } catch (error) {
                    console.warn(`${rink} - ${error}`);
                }
            }
        });
    }
};

window.setTimeout(() => {
    parsePages();
    appendSchedules(tables);
}, 1000);